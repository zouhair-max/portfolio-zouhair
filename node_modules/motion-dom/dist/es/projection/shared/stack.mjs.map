{"version":3,"file":"stack.mjs","sources":["../../../../src/projection/shared/stack.ts"],"sourcesContent":["import { addUniqueItem, removeItem } from \"motion-utils\"\nimport { IProjectionNode } from \"../node/types\"\n\nexport class NodeStack {\n    lead?: IProjectionNode\n    prevLead?: IProjectionNode\n    members: IProjectionNode[] = []\n\n    add(node: IProjectionNode) {\n        addUniqueItem(this.members, node)\n\n        for (let i = this.members.length - 1; i >= 0; i--) {\n            const m = this.members[i]\n            if (m === node || m === this.lead || m === this.prevLead) continue\n            const inst = m.instance as HTMLElement | undefined\n            if (inst && inst.isConnected === false && m.isPresent !== false && !m.snapshot) {\n                removeItem(this.members, m)\n            }\n        }\n\n        node.scheduleRender()\n    }\n\n    remove(node: IProjectionNode) {\n        removeItem(this.members, node)\n        if (node === this.prevLead) {\n            this.prevLead = undefined\n        }\n        if (node === this.lead) {\n            const prevLead = this.members[this.members.length - 1]\n            if (prevLead) {\n                this.promote(prevLead)\n            }\n        }\n    }\n\n    relegate(node: IProjectionNode): boolean {\n        const indexOfNode = this.members.findIndex((member) => node === member)\n        if (indexOfNode === 0) return false\n\n        /**\n         * Find the next projection node that is present\n         */\n        let prevLead: IProjectionNode | undefined\n        for (let i = indexOfNode; i >= 0; i--) {\n            const member = this.members[i]\n            const inst = member.instance as HTMLElement | undefined\n            if (member.isPresent !== false && (!inst || inst.isConnected !== false)) {\n                prevLead = member\n                break\n            }\n        }\n\n        if (prevLead) {\n            this.promote(prevLead)\n            return true\n        } else {\n            return false\n        }\n    }\n\n    promote(node: IProjectionNode, preserveFollowOpacity?: boolean) {\n        const prevLead = this.lead\n\n        if (node === prevLead) return\n\n        this.prevLead = prevLead\n        this.lead = node\n\n        node.show()\n\n        if (prevLead) {\n            prevLead.instance && prevLead.scheduleRender()\n            node.scheduleRender()\n\n            /**\n             * If both the new and previous lead have the same defined layoutDependency,\n             * skip the shared layout animation. This allows components with layoutId\n             * to opt-out of animations when their layoutDependency hasn't changed,\n             * even when the component unmounts and remounts in a different location.\n             */\n            const prevDep = prevLead.options.layoutDependency\n            const nextDep = node.options.layoutDependency\n            const dependencyMatches =\n                prevDep !== undefined &&\n                nextDep !== undefined &&\n                prevDep === nextDep\n\n            if (!dependencyMatches) {\n                const prevInstance = prevLead.instance as HTMLElement | undefined\n                const isStale = prevInstance && prevInstance.isConnected === false && !prevLead.snapshot\n\n                if (!isStale) {\n                    node.resumeFrom = prevLead\n\n                    if (preserveFollowOpacity) {\n                        node.resumeFrom.preserveOpacity = true\n                    }\n\n                    if (prevLead.snapshot) {\n                        node.snapshot = prevLead.snapshot\n                        node.snapshot.latestValues =\n                            prevLead.animationValues || prevLead.latestValues\n                    }\n\n                    if (node.root && node.root.isUpdating) {\n                        node.isLayoutDirty = true\n                    }\n                }\n            }\n\n            const { crossfade } = node.options\n            if (crossfade === false) {\n                prevLead.hide()\n            }\n        }\n    }\n\n    exitAnimationComplete() {\n        this.members.forEach((node) => {\n            const { options, resumingFrom } = node\n\n            options.onExitComplete && options.onExitComplete()\n\n            if (resumingFrom) {\n                resumingFrom.options.onExitComplete &&\n                    resumingFrom.options.onExitComplete()\n            }\n        })\n    }\n\n    scheduleRender() {\n        this.members.forEach((node) => {\n            node.instance && node.scheduleRender(false)\n        })\n    }\n\n    /**\n     * Clear any leads that have been removed this render to prevent them from being\n     * used in future animations and to prevent memory leaks\n     */\n    removeLeadSnapshot() {\n        if (this.lead && this.lead.snapshot) {\n            this.lead.snapshot = undefined\n        }\n    }\n}\n"],"names":[],"mappings":"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"}